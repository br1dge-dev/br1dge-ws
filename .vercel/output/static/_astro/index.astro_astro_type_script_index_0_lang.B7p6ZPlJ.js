const C=document.getElementById("canvas"),i=C.getContext("2d"),x={ctx:null,masterGain:null,compressor:null,initialized:!1,muted:!1,init(){if(!this.initialized)try{this.ctx=new(window.AudioContext||window.webkitAudioContext),this.compressor=this.ctx.createDynamicsCompressor(),this.compressor.threshold.setValueAtTime(-24,this.ctx.currentTime),this.compressor.knee.setValueAtTime(30,this.ctx.currentTime),this.compressor.ratio.setValueAtTime(12,this.ctx.currentTime),this.compressor.attack.setValueAtTime(.003,this.ctx.currentTime),this.compressor.release.setValueAtTime(.25,this.ctx.currentTime),this.compressor.connect(this.ctx.destination),this.masterGain=this.ctx.createGain(),this.masterGain.gain.setValueAtTime(.6,this.ctx.currentTime),this.masterGain.connect(this.compressor),this.initialized=!0}catch{console.warn("Web Audio API not supported")}},async resume(){this.ctx&&this.ctx.state==="suspended"&&await this.ctx.resume()},toggleMute(){if(!this.initialized)return!1;this.muted=!this.muted;const t=this.muted?0:.6;return this.masterGain.gain.linearRampToValueAtTime(t,this.ctx.currentTime+.1),this.muted},playCollect(t=0){if(!this.initialized||this.muted)return;const e=this.ctx.currentTime,s=[784,932,1047,1175,1397],a=s[Math.min(t,s.length-1)];[-8,8].forEach(c=>{const o=this.ctx.createOscillator(),r=this.ctx.createBiquadFilter(),l=this.ctx.createGain();o.type="triangle",o.frequency.setValueAtTime(a,e),o.detune.setValueAtTime(c,e),r.type="lowpass",r.frequency.setValueAtTime(3e3,e),r.frequency.exponentialRampToValueAtTime(800,e+.12),o.connect(r),r.connect(l),l.connect(this.masterGain),l.gain.setValueAtTime(0,e),l.gain.linearRampToValueAtTime(.07,e+.015),l.gain.exponentialRampToValueAtTime(.001,e+.15),o.start(e),o.stop(e+.18)})},playCapture(){if(!this.initialized||this.muted)return;const t=this.ctx.currentTime,e=this.ctx.createOscillator(),s=this.ctx.createOscillator(),a=this.ctx.createGain();e.type="sine",e.frequency.setValueAtTime(98,t),e.frequency.exponentialRampToValueAtTime(49,t+.2),s.type="triangle",s.frequency.setValueAtTime(98,t),s.frequency.exponentialRampToValueAtTime(49,t+.2),e.connect(a),s.connect(a),a.connect(this.masterGain),a.gain.setValueAtTime(0,t),a.gain.linearRampToValueAtTime(.2,t+.02),a.gain.exponentialRampToValueAtTime(.001,t+.3),e.start(t),s.start(t),e.stop(t+.35),s.stop(t+.35)},playDischarge(t=1){if(!this.initialized||this.muted)return;const e=this.ctx.currentTime;[-10,0,10].forEach(s=>{const a=this.ctx.createOscillator(),c=this.ctx.createBiquadFilter(),o=this.ctx.createGain();a.type="triangle",a.frequency.setValueAtTime(98+t*2,e),a.frequency.exponentialRampToValueAtTime(49,e+.3),a.detune.setValueAtTime(s,e),c.type="lowpass",c.frequency.setValueAtTime(600+t*50,e),c.frequency.exponentialRampToValueAtTime(150,e+.35),a.connect(c),c.connect(o),o.connect(this.masterGain),o.gain.setValueAtTime(0,e),o.gain.linearRampToValueAtTime(.12,e+.03),o.gain.exponentialRampToValueAtTime(.001,e+.4),a.start(e),a.stop(e+.45)})},playLevelUp(t=1){if(!this.initialized||this.muted)return;const e=this.ctx.currentTime,s=[392,466,587],a=[-8,0,8];s.forEach(c=>{a.forEach(o=>{const r=this.ctx.createOscillator(),l=this.ctx.createBiquadFilter(),f=this.ctx.createGain();r.type="triangle",r.frequency.setValueAtTime(c,e),r.detune.setValueAtTime(o,e),l.type="lowpass",l.frequency.setValueAtTime(800,e),l.frequency.linearRampToValueAtTime(2500,e+.25),l.frequency.exponentialRampToValueAtTime(600,e+.9),r.connect(l),l.connect(f),f.connect(this.masterGain),f.gain.setValueAtTime(0,e),f.gain.linearRampToValueAtTime(.045,e+.2),f.gain.exponentialRampToValueAtTime(.001,e+1),r.start(e),r.stop(e+1.05)})})},playMaxStack(){if(!this.initialized||this.muted)return;const t=this.ctx.currentTime,e=[196,233,294,349],s=[-10,0,10];e.forEach(a=>{s.forEach(c=>{const o=this.ctx.createOscillator(),r=this.ctx.createBiquadFilter(),l=this.ctx.createGain();o.type="triangle",o.frequency.setValueAtTime(a,t),o.detune.setValueAtTime(c,t),r.type="lowpass",r.frequency.setValueAtTime(500,t),r.frequency.linearRampToValueAtTime(3e3,t+.4),r.frequency.setValueAtTime(3e3,t+1),r.frequency.exponentialRampToValueAtTime(400,t+1.8),o.connect(r),r.connect(l),l.connect(this.masterGain),l.gain.setValueAtTime(0,t),l.gain.linearRampToValueAtTime(.035,t+.3),l.gain.setValueAtTime(.035,t+1.1),l.gain.exponentialRampToValueAtTime(.001,t+2),o.start(t),o.stop(t+2.1)})})},playModalEnter(){if(!this.initialized||this.muted)return;const t=this.ctx.currentTime;[587,1174].forEach((e,s)=>{const a=this.ctx.createOscillator(),c=this.ctx.createGain();a.type="sine",a.frequency.setValueAtTime(e,t),a.connect(c),c.connect(this.masterGain);const o=s===0?.1:.03;c.gain.setValueAtTime(0,t),c.gain.linearRampToValueAtTime(o,t+.02),c.gain.exponentialRampToValueAtTime(.001,t+.8),a.start(t),a.stop(t+.85)})},playModalClose(){if(!this.initialized||this.muted)return;const t=this.ctx.currentTime,e=this.ctx.createOscillator(),s=this.ctx.createGain();e.type="sine",e.frequency.setValueAtTime(392,t),e.frequency.exponentialRampToValueAtTime(370,t+.4),e.connect(s),s.connect(this.masterGain),s.gain.setValueAtTime(.08,t),s.gain.exponentialRampToValueAtTime(.001,t+.45),e.start(t),e.stop(t+.5)},playNoiseBurst(t=.1,e=1e3){if(!this.initialized||this.muted)return;const s=this.ctx.currentTime,a=this.ctx.sampleRate*t,c=this.ctx.createBuffer(1,a,this.ctx.sampleRate),o=c.getChannelData(0);for(let g=0;g<a;g++)o[g]=Math.random()*2-1;const r=this.ctx.createBufferSource(),l=this.ctx.createBiquadFilter(),f=this.ctx.createGain();r.buffer=c,l.type="lowpass",l.frequency.setValueAtTime(e,s),r.connect(l),l.connect(f),f.connect(this.masterGain),f.gain.setValueAtTime(.15,s),f.gain.exponentialRampToValueAtTime(.001,s+t),r.start(s)},bgMusic:null,bgMusicGain:null,bgMusicStarted:!1,async loadBgMusic(){if(!(this.bgMusic||!this.initialized||!this.ctx))try{const e=await(await fetch("/bg-music.mp3")).arrayBuffer();this.bgMusic=await this.ctx.decodeAudioData(e)}catch(t){console.warn("Failed to load background music:",t)}},async startBgMusic(){if(!this.initialized||this.muted||this.bgMusicStarted||!this.bgMusic&&(await this.loadBgMusic(),!this.bgMusic))return;this.bgMusicStarted=!0;const t=this.ctx.createBufferSource();this.bgMusicGain=this.ctx.createGain(),t.buffer=this.bgMusic,t.loop=!0,t.connect(this.bgMusicGain),this.bgMusicGain.connect(this.masterGain),this.bgMusicGain.gain.setValueAtTime(0,this.ctx.currentTime),this.bgMusicGain.gain.linearRampToValueAtTime(.25,this.ctx.currentTime+2),t.start(0),this.bgMusicSource=t},stopBgMusic(){if(!this.bgMusicStarted||!this.bgMusicSource)return;const t=this.ctx.currentTime;this.bgMusicGain.gain.linearRampToValueAtTime(0,t+1),setTimeout(()=>{try{this.bgMusicSource.stop()}catch{}this.bgMusicStarted=!1},1100)}},q={supported:"vibrate"in navigator,vibrate(t){this.supported&&!x.muted&&navigator.vibrate(t)},collect(){this.vibrate(15)},capture(){this.vibrate(50)},discharge(){this.vibrate(100)},levelUp(){this.vibrate([25,50,25])},maxStack(){this.vibrate([40,80,40,80,40])},modalEnter(){this.vibrate(60)}};let tt=!1;function U(){tt||(tt=!0,x.init(),x.resume())}document.addEventListener("click",U,{once:!1});document.addEventListener("touchstart",U,{once:!1});document.addEventListener("visibilitychange",()=>{document.hidden&&x.bgMusicStarted&&x.bgMusicGain?x.bgMusicGain.gain.linearRampToValueAtTime(0,x.ctx.currentTime+.5):!document.hidden&&x.bgMusicStarted&&!x.muted&&x.bgMusicGain&&x.bgMusicGain.gain.linearRampToValueAtTime(.25,x.ctx.currentTime+.5)});let h,m,st,ot,Y=0,F=0,I=0,X=0,j=1,O=1,w=1,p=0,B=0;const D=[];let M=0;const $=.2,G=1;let E=!1,H=0,S=0;const L=6;let V=!1;const n={x:0,y:0,vx:0,vy:0,active:!1,phase:0,turnTimer:0};let _=!1;const P=[],k=[],z=[];function rt(){h=C.width=window.innerWidth,m=C.height=window.innerHeight,st=h/2,ot=m/2}function ct(t,e){const s=t-st,a=e-ot;return Math.sqrt(s*s+a*a)}let W=!1,K=0,J=0,et=0,at=0;function lt(t){x.playModalClose(),t.style.opacity="0",setTimeout(()=>{t.remove(),W=!1,_&&xt()},800)}function ut(t){p=0,w=1,M=0,E=!1,S=0,n.active=!1,V=!1,B=0,_=!1;const e=document.getElementById("restart-overlay-btn");e&&e.remove(),t&&lt(t)}function xt(){const t=document.getElementById("restart-overlay-btn");t&&t.remove();const e=document.createElement("button");e.id="restart-overlay-btn",e.textContent="RESTART";const s=Math.min(h,m)*.18*w;e.style.cssText=`
          position: fixed;
          left: 50%;
          top: calc(50% + ${s}px);
          transform: translateX(-50%);
          background: transparent;
          border: 1px solid rgba(255,255,255,0.2);
          color: rgba(255,255,255,0.4);
          padding: 0.5rem 1.2rem;
          font-size: 0.75rem;
          cursor: none;
          transition: all 0.3s;
          letter-spacing: 0.15em;
          font-family: "SF Pro Display", system-ui, sans-serif;
          z-index: 100;
          opacity: 0;
        `,e.addEventListener("mouseenter",()=>{e.style.borderColor="rgba(255,255,255,0.5)",e.style.color="#fff"}),e.addEventListener("mouseleave",()=>{e.style.borderColor="rgba(255,255,255,0.2)",e.style.color="rgba(255,255,255,0.4)"}),e.addEventListener("click",()=>ut(null)),document.body.appendChild(e),requestAnimationFrame(()=>{e.style.opacity="1"})}function dt(){if(W)return;W=!0,x.playModalEnter(),q.modalEnter(),C.style.filter="",V=!1;const t=document.createElement("div");t.id="level10-modal",t.style.cssText=`
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: #fff; color: #000; display: flex; flex-direction: column;
          justify-content: center; align-items: center; z-index: 1000;
          font-family: "SF Pro Display", "Helvetica Neue", system-ui, sans-serif;
          opacity: 0; transition: opacity 2.5s ease; cursor: none;
        `,t.innerHTML=`
          <button id="close-btn" style="position: absolute; top: 2rem; right: 2rem; background: transparent; border: none; color: #000; font-size: 1.5rem; cursor: none; padding: 0.5rem; opacity: 0.4; transition: opacity 0.3s;">✕</button>
          <div style="font-size: 7rem; font-weight: 100; margin-bottom: 0.5rem; letter-spacing: -0.05em;">∩</div>
          <h1 style="font-size: 2rem; font-weight: 200; margin-bottom: 1rem; letter-spacing: 0.3em; text-transform: uppercase;">Level 10</h1>
          <p style="font-size: 0.9rem; margin-bottom: 2.5rem; opacity: 0.5; font-weight: 300;">Good job! You may now follow me</p>
          <div style="display: flex; gap: 1.2rem; margin-bottom: 2rem;">
            <a href="https://x.com/br1dge_eth" target="_blank" class="modal-link" style="color: #000; text-decoration: none; font-size: 0.9rem; padding: 0.7rem 1.8rem; border: 1px solid rgba(0,0,0,0.2); transition: all 0.3s; letter-spacing: 0.1em;">X / TWITTER</a>
            <a href="https://farcaster.xyz/br1dge" target="_blank" class="modal-link" style="color: #000; text-decoration: none; font-size: 0.9rem; padding: 0.7rem 1.8rem; border: 1px solid rgba(0,0,0,0.2); transition: all 0.3s; letter-spacing: 0.1em;">FARCASTER</a>
          </div>
          <button id="restart-btn" style="background: transparent; border: 1px solid rgba(0,0,0,0.15); color: rgba(0,0,0,0.4); padding: 0.5rem 1.2rem; font-size: 0.75rem; cursor: none; transition: all 0.3s; letter-spacing: 0.15em; font-family: inherit;">RESTART</button>
          <p style="font-size: 0.75rem; margin-top: 2.5rem; opacity: 0.5; font-weight: 300; text-align: center; max-width: 280px; line-height: 1.5;">Kudos to Switch Angel for the awesome track! I honestly butchered it. Make sure you subscribe to her channel!</p>
          <a href="https://www.youtube.com/watch?v=hFSwWzxrqUA" target="_blank" class="modal-link" style="color: #000; text-decoration: none; font-size: 0.75rem; padding: 0.5rem 1.2rem; border: 1px solid rgba(0,0,0,0.15); transition: all 0.3s; letter-spacing: 0.1em; margin-top: 1rem;">SUBSCRIBE</a>
          <p style="position: absolute; bottom: 2rem; font-size: 0.7rem; opacity: 0.25;">br1dge.xyz</p>
          <div id="modal-cursor" style="position: fixed; pointer-events: none; z-index: 1001;">
            <div style="width: 6px; height: 6px; background: #000; border-radius: 50%;"></div>
            <div style="position: absolute; top: -9px; left: -9px; width: 24px; height: 24px; border: 1px solid rgba(0,0,0,0.3); border-radius: 50%;"></div>
          </div>
        `,document.body.appendChild(t);const e=document.getElementById("modal-cursor"),s=document.getElementById("close-btn"),a=document.getElementById("restart-btn");t.addEventListener("mousemove",o=>{et=o.clientX,at=o.clientY});function c(){W&&(K+=(et-K)*.2,J+=(at-J)*.2,e&&(e.style.left=K-3+"px",e.style.top=J-3+"px"),requestAnimationFrame(c))}c(),s.addEventListener("mouseenter",()=>{s.style.opacity="1"}),s.addEventListener("mouseleave",()=>{s.style.opacity="0.4"}),s.addEventListener("click",()=>lt(t)),t.querySelectorAll(".modal-link").forEach(o=>{o.addEventListener("mouseenter",()=>{o.style.background="rgba(0,0,0,0.05)",o.style.borderColor="#000"}),o.addEventListener("mouseleave",()=>{o.style.background="transparent",o.style.borderColor="rgba(0,0,0,0.2)"})}),a.addEventListener("mouseenter",()=>{a.style.borderColor="rgba(0,0,0,0.4)",a.style.color="#000"}),a.addEventListener("mouseleave",()=>{a.style.borderColor="rgba(0,0,0,0.15)",a.style.color="rgba(0,0,0,0.4)"}),a.addEventListener("click",()=>ut(t)),requestAnimationFrame(()=>{t.style.opacity="1"})}function bt(){i.fillStyle="#000000",i.fillRect(0,0,h,m);const t=i.createRadialGradient(h/2,m/2,0,h/2,m/2,Math.max(h,m)*.7);t.addColorStop(0,"rgba(20, 20, 25, 0.5)"),t.addColorStop(1,"transparent"),i.fillStyle=t,i.fillRect(0,0,h,m);const e=80,s=1;i.fillStyle="rgba(255, 255, 255, 0.03)";for(let a=e;a<h;a+=e)for(let c=e;c<m;c+=e)i.beginPath(),i.arc(a,c,s,0,Math.PI*2),i.fill();i.strokeStyle="rgba(255, 255, 255, 0.015)",i.lineWidth=1;for(let a=0;a<h;a+=200)i.beginPath(),i.moveTo(a,0),i.lineTo(a,m),i.stroke()}function Mt(){const t=Math.min(h,m)*.32;j+=(O-j)*.12,B+=.008;const e=Math.sin(B)*.008,s=Math.sin(B*1.7)*.003,a=Math.sin(B*.5)*.005,c=1+e+s+a,o=w*j*c,r=h/2,l=m/2;if(i.save(),i.translate(r,l),i.scale(o,o),i.font=`200 ${t}px "SF Pro Display", "Helvetica Neue", system-ui, sans-serif`,i.textAlign="center",i.textBaseline="middle",p>0){let f;p<=4?f=2+p*1:f=6+Math.log(p-3)*1.5;const g=f;let b;p<=4?b=.15+p*.04:b=.31+Math.log(p-3)*.025,i.globalAlpha=b,i.fillStyle="#ff0066",i.fillText("∩",-g,0),i.fillStyle="#00ffff",i.fillText("∩",g,0),i.globalAlpha=1}i.fillStyle="#ffffff",i.fillText("∩",0,0),i.restore(),i.font="12px monospace",i.textAlign="right",i.fillStyle="rgba(255, 255, 255, 0.4)",i.fillText(`lvl:${p}`,h-20,m-20);for(let f=D.length-1;f>=0;f--){const g=D[f];if(g.alpha*=.96,g.radius=(g.radius||10)+5,g.alpha<.01){D.splice(f,1);continue}i.beginPath(),i.arc(r,l,g.radius*w,0,Math.PI*2),i.strokeStyle=g.hue!==void 0?`hsla(${g.hue}, 100%, 70%, ${g.alpha})`:`rgba(255, 255, 255, ${g.alpha})`,i.lineWidth=2,i.stroke()}}function Tt(){for(let t=P.length-1;t>=0;t--){const e=P[t];if(e.x+=e.vx,e.y+=e.vy,e.vx*=.96,e.vy*=.96,e.life-=.02,e.life<=0){P.splice(t,1);continue}i.beginPath(),i.arc(e.x,e.y,2,0,Math.PI*2),i.fillStyle=e.hue?`hsla(${e.hue}, 100%, 70%, ${e.life})`:`rgba(255, 255, 255, ${e.life})`,i.fill()}}function vt(){if(z.length<180&&Math.random()<.45){let s,a,c,o;if(Math.random()<.2){switch(Math.floor(Math.random()*4)){case 0:s=Math.random()*h,a=-10;break;case 1:s=h+10,a=Math.random()*m;break;case 2:s=Math.random()*h,a=m+10;break;default:s=-10,a=Math.random()*m}const f=h/2,g=m/2,b=f-s,y=g-a,u=Math.sqrt(b*b+y*y);c=b/u*(.3+Math.random()*.3),o=y/u*(.3+Math.random()*.3)}else{const l=Math.random(),f=Math.random(),g=Math.sqrt(-2*Math.log(l))*Math.cos(2*Math.PI*f),b=Math.sqrt(-2*Math.log(l))*Math.sin(2*Math.PI*f);s=h/2+g*h*.35,a=m/2+b*m*.35,s=Math.max(20,Math.min(h-20,s)),a=Math.max(20,Math.min(m-20,a));const y=Math.random()*Math.PI*2,u=.05+Math.random()*.15;c=Math.cos(y)*u,o=Math.sin(y)*u}z.push({x:s,y:a,vx:c,vy:o,size:1.5+Math.random()*2.5,alpha:.4+Math.random()*.4,twinkle:Math.random()*Math.PI*2,absorbed:!1})}for(let s=z.length-1;s>=0;s--){const a=z[s],c=I-a.x,o=X-a.y,r=Math.sqrt(c*c+o*o),l=280;if(r<l&&r>8){const b=r/l,y=Math.pow(1-b,2)*.15;a.vx+=c/r*y,a.vy+=o/r*y,r<100&&(a.vx+=c/r*.08,a.vy+=o/r*.08)}if(r<20&&!a.absorbed&&M<G){a.absorbed=!0;const b=M;M=Math.min(G,M+.008),a.alpha*=.2,Math.floor(M*10)>Math.floor(b*10)&&(x.playCollect(Math.floor(M*5)),q.collect()),M>=G&&!n.active&&!E&&(H=Date.now()+1500,E=!0)}if(a.x+=a.vx,a.y+=a.vy,a.vx*=.985,a.vy*=.985,a.twinkle+=.05,a.absorbed&&(a.alpha*=.8),a.x<-50||a.x>h+50||a.y<-50||a.y>m+50||a.alpha<.01){z.splice(s,1);continue}const f=a.alpha*(.7+Math.sin(a.twinkle)*.3);let g=f;r<l&&!a.absorbed&&(g=f*(1+(1-r/l)*.5)),i.beginPath(),i.arc(a.x,a.y,a.size*(a.absorbed?.3:1),0,Math.PI*2),i.fillStyle=`rgba(255, 255, 255, ${Math.min(1,g)})`,i.fill()}}function At(){const t=Date.now()/1e3;if(E&&!n.active&&Date.now()>H){const y=Math.floor(Math.random()*4),u=3+Math.random()*2;switch(y){case 0:n.x=Math.random()*h,n.y=-10;break;case 1:n.x=h+10,n.y=Math.random()*m;break;case 2:n.x=Math.random()*h,n.y=m+10;break;default:n.x=-10,n.y=Math.random()*m}const d=h/2+(Math.random()-.5)*h*.4,T=m/2+(Math.random()-.5)*m*.4,A=d-n.x,v=T-n.y,R=Math.sqrt(A*A+v*v);n.vx=A/R*u,n.vy=v/R*u,n.active=!0,n.phase=Math.random()*Math.PI*2,n.turnTimer=0}if(!n.active)return;if(n.phase+=.08,n.turnTimer++,n.turnTimer>60+Math.random()*60){n.turnTimer=0;const y=(Math.random()-.5)*Math.PI*.8,u=Math.sqrt(n.vx*n.vx+n.vy*n.vy),T=Math.atan2(n.vy,n.vx)+y;n.vx=Math.cos(T)*u,n.vy=Math.sin(T)*u}const e=Math.sqrt(n.vx*n.vx+n.vy*n.vy),s=Math.sin(n.phase)*2.5+Math.sin(n.phase*2.3)*1.5,a=-n.vy/e,c=n.vx/e;n.x+=n.vx+a*s,n.y+=n.vy+c*s;const o=80,r=.15;n.x<o&&(n.vx+=r),n.x>h-o&&(n.vx-=r),n.y<o&&(n.vy+=r),n.y>m-o&&(n.vy-=r);const l=I-n.x,f=X-n.y;if(Math.sqrt(l*l+f*f)<30){if(n.active=!1,x.playCapture(),q.capture(),V&&S<L){if(S++,S>=L){x.playMaxStack(),q.maxStack();for(let y=0;y<100;y++){const u=y/100*Math.PI*2,d=12+Math.random()*12;P.push({x:n.x,y:n.y,vx:Math.cos(u)*d,vy:Math.sin(u)*d,life:1.5,hue:45})}}}else V=!0,C.style.filter="invert(1)",S=1;for(let y=0;y<60;y++){const u=y/60*Math.PI*2,d=8+Math.random()*8;P.push({x:n.x,y:n.y,vx:Math.cos(u)*d,vy:Math.sin(u)*d,life:1.2,hue:0})}for(let y=0;y<4;y++)setTimeout(()=>{k.push({x:n.x,y:n.y,size:10+y*30,alpha:1,hue:0})},y*50);V&&S<L&&M>=G&&(H=Date.now()+1500,E=!0)}(n.x<-100||n.x>h+100||n.y<-100||n.y>m+100)&&(n.active=!1,M>=G&&(H=Date.now()+2e3,E=!0));const b=1+Math.sin(t*10)*.2;i.beginPath(),i.arc(n.x,n.y,5*b,0,Math.PI*2),i.fillStyle="#ff2222",i.fill(),i.beginPath(),i.moveTo(n.x,n.y),i.lineTo(n.x-n.vx*2,n.y-n.vy*2),i.strokeStyle="rgba(255, 34, 34, 0.6)",i.lineWidth=3,i.stroke()}function St(){const t=i.createRadialGradient(h/2,m/2,Math.min(h,m)*.3,h/2,m/2,Math.max(h,m)*.8);t.addColorStop(0,"transparent"),t.addColorStop(.7,"transparent"),t.addColorStop(1,"rgba(0, 0, 0, 0.5)"),i.fillStyle=t,i.fillRect(0,0,h,m)}function wt(){for(let t=k.length-1;t>=0;t--){const e=k[t];if(e.size+=12,e.alpha-=.02,e.alpha<=0){k.splice(t,1);continue}i.beginPath(),i.arc(e.x,e.y,e.size,0,Math.PI*2),i.strokeStyle=e.hue!==void 0?`hsla(${e.hue}, 100%, 70%, ${e.alpha})`:`rgba(255, 255, 255, ${e.alpha})`,i.lineWidth=2,i.stroke()}}function Vt(){const t=h/2,e=m/2,s=Y-t,a=F-e,c=Math.sqrt(s*s+a*a);let o=0,r=0;const l=180;if(c<l&&M>=$){const v=1-c/l,R=M*v*.6;c>1&&(o=-(s/c)*R*c*.3,r=-(a/c)*R*c*.3)}const f=Y+o,g=F+r;I+=(f-I)*.25,X+=(g-X)*.25;const b=5,y=M*18,u=b+y;i.save(),i.translate(I,X);const d=5,T=G/d;for(let v=0;v<d;v++){const R=v*T,Z=Math.max(0,Math.min(1,(M-R)/T));if(Z<=0)continue;const pt=u+5+v*5,gt=4,yt=S>=d-v;i.beginPath(),i.arc(0,0,pt,-Math.PI/2,-Math.PI/2+Z*Math.PI*2),i.strokeStyle=yt?"#00ffff":"#ffffff",i.lineWidth=gt,i.lineCap="butt",i.stroke()}const A=S>=L;i.beginPath(),i.arc(0,0,u,0,Math.PI*2),i.fillStyle=A?"#00ffff":"#ffffff",i.fill(),i.restore()}function ht(){i.fillStyle="#000",i.fillRect(0,0,h,m),bt(),vt(),At(),Tt(),Mt(),wt(),Vt(),St(),requestAnimationFrame(ht)}window.addEventListener("resize",rt);document.addEventListener("mousemove",t=>{Y=t.clientX,F=t.clientY});document.addEventListener("click",t=>{const e=ct(t.clientX,t.clientY),s=Math.min(h,m)*.22*w,a=h/2,c=m/2;if(k.push({x:t.clientX,y:t.clientY,size:5,alpha:.5,hue:0}),e<s&&M>=$&&p<10){let o=1,r=!1;const l=p;S>=L?(r=!0,p=10,w=1+.18*10):V?(o=3*S,p=Math.min(10,p+o),w+=.18*o):(p=Math.min(10,p+1),w+=.18),x.playDischarge(p),q.discharge(),p>l&&setTimeout(()=>{x.playLevelUp(p),q.levelUp()},150),V&&(V=!1,C.style.filter=""),S=0,!x.bgMusicStarted&&M>=$&&x.startBgMusic();const f=M,g=r?45:p*40%360,b=r?30:5+p*2;for(let u=0;u<b;u++)setTimeout(()=>{D.push({alpha:1,radius:10+u*6,hue:r?(45+u*5)%60:(g+u*15)%360})},u*(r?10:20));O=r?1.5:1.2+p*.05,setTimeout(()=>{O=1},r?300:150),p>=10&&(_=!0,setTimeout(()=>{dt()},4e3));for(let u of z){const d=u.x-a,T=u.y-c,A=Math.sqrt(d*d+T*T);if(A>0&&A<400){const v=(1-A/400)*15*f;u.vx+=d/A*v,u.vy+=T/A*v}}const y=Math.floor(50+f*80+p*12);for(let u=0;u<y;u++){const d=u/y*Math.PI*2,T=6+Math.random()*12*f;P.push({x:a,y:c,vx:Math.cos(d)*T,vy:Math.sin(d)*T,life:1,hue:(g+Math.random()*60)%360})}for(let u=0;u<3;u++)setTimeout(()=>{k.push({x:a,y:c,size:10+u*20,alpha:1,hue:(g+u*30)%360})},u*40);M=0,E=!1,n.active=!1}});document.addEventListener("touchstart",t=>{const e=t.touches[0];Y=e.clientX,F=e.clientY});document.addEventListener("touchmove",t=>{const e=t.touches[0];Y=e.clientX,F=e.clientY,t.preventDefault()},{passive:!1});document.addEventListener("touchend",t=>{if(t.changedTouches.length>0){const e=t.changedTouches[0],s=ct(e.clientX,e.clientY),a=Math.min(h,m)*.22*w,c=h/2,o=m/2;if(k.push({x:e.clientX,y:e.clientY,size:5,alpha:.5,hue:0}),s<a&&M>=$&&p<10){let r=1,l=!1;const f=p;S>=L?(l=!0,p=10,w=1+.18*10):V?(r=3*S,p=Math.min(10,p+r),w+=.18*r):(p=Math.min(10,p+1),w+=.18),x.playDischarge(p),q.discharge(),p>f&&setTimeout(()=>{x.playLevelUp(p),q.levelUp()},150),V&&(V=!1,C.style.filter=""),S=0,!x.bgMusicStarted&&M>=$&&x.startBgMusic();const g=M,b=l?45:p*50%360,y=l?30:5+p*2;for(let d=0;d<y;d++)setTimeout(()=>{D.push({alpha:1,radius:15+d*8,hue:l?(45+d*5)%60:(b+d*20)%360})},d*(l?10:25));O=l?1.5:1.25,setTimeout(()=>{O=1},l?300:120),p>=10&&(_=!0,setTimeout(()=>{dt()},4e3));for(let d of z){const T=d.x-c,A=d.y-o,v=Math.sqrt(T*T+A*A);if(v>0&&v<400){const R=(1-v/400)*15*g;d.vx+=T/v*R,d.vy+=A/v*R}}const u=Math.floor(50+g*80+p*12);for(let d=0;d<u;d++){const T=d/u*Math.PI*2,A=6+Math.random()*12*g;P.push({x:c,y:o,vx:Math.cos(T)*A,vy:Math.sin(T)*A,life:1,hue:(b+Math.random()*60)%360})}for(let d=0;d<3;d++)setTimeout(()=>{k.push({x:c,y:o,size:10+d*20,alpha:1,hue:(b+d*30)%360})},d*40);M=0,E=!1,n.active=!1}}});const Q=document.getElementById("sound-hint"),Rt=Q?.querySelectorAll("span:not(.speaker)");Rt?.forEach((t,e)=>{const s=Math.random()*1.5;t.style.animationDelay=`${s}s`});function mt(){Q?.classList.add("hidden")}const N=document.getElementById("sound-toggle"),it=N?.querySelector(".sound-on"),nt=N?.querySelector(".sound-off");function ft(t){it&&nt&&(it.style.display=t?"none":"block",nt.style.display=t?"block":"none"),N?.classList.toggle("muted",t)}function Et(){U(),x.muted&&x.toggleMute(),mt(),ft(!1)}Q?.addEventListener("click",t=>{t.stopPropagation(),Et()});N?.addEventListener("click",t=>{t.stopPropagation(),U();const e=x.toggleMute();ft(e),e||mt(),e?x.stopBgMusic():x.bgMusic&&!x.bgMusicStarted&&x.startBgMusic()});rt();ht();
