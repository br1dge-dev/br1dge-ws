const C=document.getElementById("canvas"),i=C.getContext("2d"),x={ctx:null,masterGain:null,compressor:null,initialized:!1,muted:!1,init(){if(!this.initialized)try{this.ctx=new(window.AudioContext||window.webkitAudioContext),this.compressor=this.ctx.createDynamicsCompressor(),this.compressor.threshold.setValueAtTime(-24,this.ctx.currentTime),this.compressor.knee.setValueAtTime(30,this.ctx.currentTime),this.compressor.ratio.setValueAtTime(12,this.ctx.currentTime),this.compressor.attack.setValueAtTime(.003,this.ctx.currentTime),this.compressor.release.setValueAtTime(.25,this.ctx.currentTime),this.compressor.connect(this.ctx.destination),this.masterGain=this.ctx.createGain(),this.masterGain.gain.setValueAtTime(.6,this.ctx.currentTime),this.masterGain.connect(this.compressor),this.initialized=!0}catch{console.warn("Web Audio API not supported")}},async resume(){this.ctx&&this.ctx.state==="suspended"&&await this.ctx.resume()},toggleMute(){if(!this.initialized)return!1;this.muted=!this.muted;const t=this.muted?0:.6;return this.masterGain.gain.linearRampToValueAtTime(t,this.ctx.currentTime+.1),this.muted},playCollect(t=0){if(!this.initialized||this.muted)return;const e=this.ctx.currentTime,n=[784,932,1047,1175,1397],a=n[Math.min(t,n.length-1)];[-6,6].forEach(o=>{const r=this.ctx.createOscillator(),c=this.ctx.createBiquadFilter(),l=this.ctx.createGain();r.type="sawtooth",r.frequency.setValueAtTime(a,e),r.detune.setValueAtTime(o+Math.random()*4,e),c.type="lowpass",c.frequency.setValueAtTime(2e3,e),c.frequency.exponentialRampToValueAtTime(400,e+.08),c.Q.setValueAtTime(2,e),r.connect(c),c.connect(l),l.connect(this.masterGain),l.gain.setValueAtTime(.06,e),l.gain.exponentialRampToValueAtTime(.001,e+.1),r.start(e),r.stop(e+.12)})},playCapture(){if(!this.initialized||this.muted)return;const t=this.ctx.currentTime,e=this.ctx.createOscillator(),n=this.ctx.createOscillator(),a=this.ctx.createGain(),o=this.ctx.createBiquadFilter(),r=this.ctx.createGain();n.type="sine",n.frequency.setValueAtTime(49,t),a.gain.setValueAtTime(30,t),a.gain.exponentialRampToValueAtTime(5,t+.2),n.connect(a),a.connect(e.frequency),e.type="sawtooth",e.frequency.setValueAtTime(98,t),e.frequency.exponentialRampToValueAtTime(49,t+.15),o.type="lowpass",o.frequency.setValueAtTime(800,t),o.frequency.exponentialRampToValueAtTime(100,t+.2),e.connect(o),o.connect(r),r.connect(this.masterGain),r.gain.setValueAtTime(.3,t),r.gain.exponentialRampToValueAtTime(.001,t+.25),n.start(t),e.start(t),n.stop(t+.3),e.stop(t+.3)},playDischarge(t=1){if(!this.initialized||this.muted)return;const e=this.ctx.currentTime;[-8,0,8].forEach(n=>{const a=this.ctx.createOscillator(),o=this.ctx.createBiquadFilter(),r=this.ctx.createGain();a.type="sawtooth",a.frequency.setValueAtTime(98+t*3,e),a.frequency.exponentialRampToValueAtTime(49,e+.25),a.detune.setValueAtTime(n,e),o.type="lowpass",o.frequency.setValueAtTime(400+t*80,e),o.frequency.exponentialRampToValueAtTime(80,e+.3),o.Q.setValueAtTime(4,e),a.connect(o),o.connect(r),r.connect(this.masterGain),r.gain.setValueAtTime(.15,e),r.gain.exponentialRampToValueAtTime(.001,e+.35),a.start(e),a.stop(e+.4)})},playLevelUp(t=1){if(!this.initialized||this.muted)return;const e=this.ctx.currentTime,n=[392,466,587],a=[-12,-6,0,6,12];n.forEach(o=>{a.forEach(r=>{const c=this.ctx.createOscillator(),l=this.ctx.createBiquadFilter(),f=this.ctx.createGain();c.type="sawtooth",c.frequency.setValueAtTime(o,e),c.detune.setValueAtTime(r+Math.random()*3,e),l.type="lowpass",l.frequency.setValueAtTime(400,e),l.frequency.linearRampToValueAtTime(1800,e+.2),l.frequency.exponentialRampToValueAtTime(300,e+.7),c.connect(l),l.connect(f),f.connect(this.masterGain),f.gain.setValueAtTime(0,e),f.gain.linearRampToValueAtTime(.025,e+.15),f.gain.exponentialRampToValueAtTime(.001,e+.8),c.start(e),c.stop(e+.85)})})},playMaxStack(){if(!this.initialized||this.muted)return;const t=this.ctx.currentTime,e=[196,233,294,349],n=[-15,-8,0,8,15];e.forEach(a=>{n.forEach(o=>{const r=this.ctx.createOscillator(),c=this.ctx.createBiquadFilter(),l=this.ctx.createGain();r.type="sawtooth",r.frequency.setValueAtTime(a,t),r.detune.setValueAtTime(o+Math.random()*4,t),c.type="lowpass",c.frequency.setValueAtTime(300,t),c.frequency.linearRampToValueAtTime(2200,t+.3),c.frequency.setValueAtTime(2200,t+.8),c.frequency.exponentialRampToValueAtTime(200,t+1.5),c.Q.setValueAtTime(1,t),r.connect(c),c.connect(l),l.connect(this.masterGain),l.gain.setValueAtTime(0,t),l.gain.linearRampToValueAtTime(.02,t+.25),l.gain.setValueAtTime(.02,t+.9),l.gain.exponentialRampToValueAtTime(.001,t+1.6),r.start(t),r.stop(t+1.7)})})},playModalEnter(){if(!this.initialized||this.muted)return;const t=this.ctx.currentTime;[-5,5].forEach(e=>{const n=this.ctx.createOscillator(),a=this.ctx.createBiquadFilter(),o=this.ctx.createGain();n.type="sawtooth",n.frequency.setValueAtTime(587,t),n.detune.setValueAtTime(e,t),a.type="lowpass",a.frequency.setValueAtTime(300,t),a.frequency.linearRampToValueAtTime(2e3,t+.1),a.frequency.exponentialRampToValueAtTime(400,t+.6),n.connect(a),a.connect(o),o.connect(this.masterGain),o.gain.setValueAtTime(0,t),o.gain.linearRampToValueAtTime(.08,t+.05),o.gain.exponentialRampToValueAtTime(.001,t+.7),n.start(t),n.stop(t+.75)})},playModalClose(){if(!this.initialized||this.muted)return;const t=this.ctx.currentTime;[-5,5].forEach(e=>{const n=this.ctx.createOscillator(),a=this.ctx.createBiquadFilter(),o=this.ctx.createGain();n.type="sawtooth",n.frequency.setValueAtTime(392,t),n.detune.setValueAtTime(e,t),a.type="lowpass",a.frequency.setValueAtTime(1500,t),a.frequency.exponentialRampToValueAtTime(200,t+.3),n.connect(a),a.connect(o),o.connect(this.masterGain),o.gain.setValueAtTime(.07,t),o.gain.exponentialRampToValueAtTime(.001,t+.35),n.start(t),n.stop(t+.4)})},playNoiseBurst(t=.1,e=1e3){if(!this.initialized||this.muted)return;const n=this.ctx.currentTime,a=this.ctx.sampleRate*t,o=this.ctx.createBuffer(1,a,this.ctx.sampleRate),r=o.getChannelData(0);for(let y=0;y<a;y++)r[y]=Math.random()*2-1;const c=this.ctx.createBufferSource(),l=this.ctx.createBiquadFilter(),f=this.ctx.createGain();c.buffer=o,l.type="lowpass",l.frequency.setValueAtTime(e,n),c.connect(l),l.connect(f),f.connect(this.masterGain),f.gain.setValueAtTime(.15,n),f.gain.exponentialRampToValueAtTime(.001,n+t),c.start(n)},bgMusic:null,bgMusicGain:null,bgMusicStarted:!1,async loadBgMusic(){if(!(this.bgMusic||!this.initialized||!this.ctx))try{const e=await(await fetch("/bg-music.mp3")).arrayBuffer();this.bgMusic=await this.ctx.decodeAudioData(e)}catch(t){console.warn("Failed to load background music:",t)}},async startBgMusic(){if(!this.initialized||this.muted||this.bgMusicStarted||!this.bgMusic&&(await this.loadBgMusic(),!this.bgMusic))return;this.bgMusicStarted=!0;const t=this.ctx.createBufferSource();this.bgMusicGain=this.ctx.createGain(),t.buffer=this.bgMusic,t.loop=!0,t.connect(this.bgMusicGain),this.bgMusicGain.connect(this.masterGain),this.bgMusicGain.gain.setValueAtTime(0,this.ctx.currentTime),this.bgMusicGain.gain.linearRampToValueAtTime(.25,this.ctx.currentTime+2),t.start(0),this.bgMusicSource=t},stopBgMusic(){if(!this.bgMusicStarted||!this.bgMusicSource)return;const t=this.ctx.currentTime;this.bgMusicGain.gain.linearRampToValueAtTime(0,t+1),setTimeout(()=>{try{this.bgMusicSource.stop()}catch{}this.bgMusicStarted=!1},1100)}},k={supported:"vibrate"in navigator,vibrate(t){this.supported&&!x.muted&&navigator.vibrate(t)},collect(){this.vibrate(15)},capture(){this.vibrate(50)},discharge(){this.vibrate(100)},levelUp(){this.vibrate([25,50,25])},maxStack(){this.vibrate([40,80,40,80,40])},modalEnter(){this.vibrate(60)}};let tt=!1;function _(){tt||(tt=!0,x.init(),x.resume())}document.addEventListener("click",_,{once:!1});document.addEventListener("touchstart",_,{once:!1});document.addEventListener("visibilitychange",()=>{document.hidden&&x.bgMusicStarted&&x.bgMusicGain?x.bgMusicGain.gain.linearRampToValueAtTime(0,x.ctx.currentTime+.5):!document.hidden&&x.bgMusicStarted&&!x.muted&&x.bgMusicGain&&x.bgMusicGain.gain.linearRampToValueAtTime(.25,x.ctx.currentTime+.5)});let h,m,st,ot,Y=0,F=0,I=0,X=0,Q=1,O=1,w=1,p=0,B=0;const D=[];let b=0;const $=.2,G=1;let E=!1,H=0,S=0;const L=6;let V=!1;const s={x:0,y:0,vx:0,vy:0,active:!1,phase:0,turnTimer:0};let U=!1;const z=[],R=[],P=[];function rt(){h=C.width=window.innerWidth,m=C.height=window.innerHeight,st=h/2,ot=m/2}function ct(t,e){const n=t-st,a=e-ot;return Math.sqrt(n*n+a*a)}let W=!1,j=0,K=0,et=0,at=0;function lt(t){x.playModalClose(),t.style.opacity="0",setTimeout(()=>{t.remove(),W=!1,U&&xt()},800)}function ut(t){p=0,w=1,b=0,E=!1,S=0,s.active=!1,V=!1,B=0,U=!1;const e=document.getElementById("restart-overlay-btn");e&&e.remove(),t&&lt(t)}function xt(){const t=document.getElementById("restart-overlay-btn");t&&t.remove();const e=document.createElement("button");e.id="restart-overlay-btn",e.textContent="RESTART";const n=Math.min(h,m)*.18*w;e.style.cssText=`
          position: fixed;
          left: 50%;
          top: calc(50% + ${n}px);
          transform: translateX(-50%);
          background: transparent;
          border: 1px solid rgba(255,255,255,0.2);
          color: rgba(255,255,255,0.4);
          padding: 0.5rem 1.2rem;
          font-size: 0.75rem;
          cursor: none;
          transition: all 0.3s;
          letter-spacing: 0.15em;
          font-family: "SF Pro Display", system-ui, sans-serif;
          z-index: 100;
          opacity: 0;
        `,e.addEventListener("mouseenter",()=>{e.style.borderColor="rgba(255,255,255,0.5)",e.style.color="#fff"}),e.addEventListener("mouseleave",()=>{e.style.borderColor="rgba(255,255,255,0.2)",e.style.color="rgba(255,255,255,0.4)"}),e.addEventListener("click",()=>ut(null)),document.body.appendChild(e),requestAnimationFrame(()=>{e.style.opacity="1"})}function dt(){if(W)return;W=!0,x.playModalEnter(),k.modalEnter(),C.style.filter="",V=!1;const t=document.createElement("div");t.id="level10-modal",t.style.cssText=`
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: #fff; color: #000; display: flex; flex-direction: column;
          justify-content: center; align-items: center; z-index: 1000;
          font-family: "SF Pro Display", "Helvetica Neue", system-ui, sans-serif;
          opacity: 0; transition: opacity 2.5s ease; cursor: none;
        `,t.innerHTML=`
          <button id="close-btn" style="position: absolute; top: 2rem; right: 2rem; background: transparent; border: none; color: #000; font-size: 1.5rem; cursor: none; padding: 0.5rem; opacity: 0.4; transition: opacity 0.3s;">✕</button>
          <div style="font-size: 7rem; font-weight: 100; margin-bottom: 0.5rem; letter-spacing: -0.05em;">∩</div>
          <h1 style="font-size: 2rem; font-weight: 200; margin-bottom: 1rem; letter-spacing: 0.3em; text-transform: uppercase;">Level 10</h1>
          <p style="font-size: 0.9rem; margin-bottom: 2.5rem; opacity: 0.5; font-weight: 300;">Good job! You may now follow me</p>
          <div style="display: flex; gap: 1.2rem; margin-bottom: 2rem;">
            <a href="https://x.com/br1dge_eth" target="_blank" class="modal-link" style="color: #000; text-decoration: none; font-size: 0.9rem; padding: 0.7rem 1.8rem; border: 1px solid rgba(0,0,0,0.2); transition: all 0.3s; letter-spacing: 0.1em;">X / TWITTER</a>
            <a href="https://farcaster.xyz/br1dge" target="_blank" class="modal-link" style="color: #000; text-decoration: none; font-size: 0.9rem; padding: 0.7rem 1.8rem; border: 1px solid rgba(0,0,0,0.2); transition: all 0.3s; letter-spacing: 0.1em;">FARCASTER</a>
          </div>
          <button id="restart-btn" style="background: transparent; border: 1px solid rgba(0,0,0,0.15); color: rgba(0,0,0,0.4); padding: 0.5rem 1.2rem; font-size: 0.75rem; cursor: none; transition: all 0.3s; letter-spacing: 0.15em; font-family: inherit;">RESTART</button>
          <p style="position: absolute; bottom: 2rem; font-size: 0.7rem; opacity: 0.25;">br1dge.xyz</p>
          <div id="modal-cursor" style="position: fixed; pointer-events: none; z-index: 1001;">
            <div style="width: 6px; height: 6px; background: #000; border-radius: 50%;"></div>
            <div style="position: absolute; top: -9px; left: -9px; width: 24px; height: 24px; border: 1px solid rgba(0,0,0,0.3); border-radius: 50%;"></div>
          </div>
        `,document.body.appendChild(t);const e=document.getElementById("modal-cursor"),n=document.getElementById("close-btn"),a=document.getElementById("restart-btn");t.addEventListener("mousemove",r=>{et=r.clientX,at=r.clientY});function o(){W&&(j+=(et-j)*.2,K+=(at-K)*.2,e&&(e.style.left=j-3+"px",e.style.top=K-3+"px"),requestAnimationFrame(o))}o(),n.addEventListener("mouseenter",()=>{n.style.opacity="1"}),n.addEventListener("mouseleave",()=>{n.style.opacity="0.4"}),n.addEventListener("click",()=>lt(t)),t.querySelectorAll(".modal-link").forEach(r=>{r.addEventListener("mouseenter",()=>{r.style.background="rgba(0,0,0,0.05)",r.style.borderColor="#000"}),r.addEventListener("mouseleave",()=>{r.style.background="transparent",r.style.borderColor="rgba(0,0,0,0.2)"})}),a.addEventListener("mouseenter",()=>{a.style.borderColor="rgba(0,0,0,0.4)",a.style.color="#000"}),a.addEventListener("mouseleave",()=>{a.style.borderColor="rgba(0,0,0,0.15)",a.style.color="rgba(0,0,0,0.4)"}),a.addEventListener("click",()=>ut(t)),requestAnimationFrame(()=>{t.style.opacity="1"})}function Mt(){i.fillStyle="#000000",i.fillRect(0,0,h,m);const t=i.createRadialGradient(h/2,m/2,0,h/2,m/2,Math.max(h,m)*.7);t.addColorStop(0,"rgba(20, 20, 25, 0.5)"),t.addColorStop(1,"transparent"),i.fillStyle=t,i.fillRect(0,0,h,m);const e=80,n=1;i.fillStyle="rgba(255, 255, 255, 0.03)";for(let a=e;a<h;a+=e)for(let o=e;o<m;o+=e)i.beginPath(),i.arc(a,o,n,0,Math.PI*2),i.fill();i.strokeStyle="rgba(255, 255, 255, 0.015)",i.lineWidth=1;for(let a=0;a<h;a+=200)i.beginPath(),i.moveTo(a,0),i.lineTo(a,m),i.stroke()}function bt(){const t=Math.min(h,m)*.32;Q+=(O-Q)*.12,B+=.008;const e=Math.sin(B)*.008,n=Math.sin(B*1.7)*.003,a=Math.sin(B*.5)*.005,o=1+e+n+a,r=w*Q*o,c=h/2,l=m/2;if(i.save(),i.translate(c,l),i.scale(r,r),i.font=`200 ${t}px "SF Pro Display", "Helvetica Neue", system-ui, sans-serif`,i.textAlign="center",i.textBaseline="middle",p>0){let f;p<=4?f=2+p*1:f=6+Math.log(p-3)*1.5;const y=f;let M;p<=4?M=.15+p*.04:M=.31+Math.log(p-3)*.025,i.globalAlpha=M,i.fillStyle="#ff0066",i.fillText("∩",-y,0),i.fillStyle="#00ffff",i.fillText("∩",y,0),i.globalAlpha=1}i.fillStyle="#ffffff",i.fillText("∩",0,0),i.restore(),i.font="12px monospace",i.textAlign="right",i.fillStyle="rgba(255, 255, 255, 0.4)",i.fillText(`lvl:${p}`,h-20,m-20);for(let f=D.length-1;f>=0;f--){const y=D[f];if(y.alpha*=.96,y.radius=(y.radius||10)+5,y.alpha<.01){D.splice(f,1);continue}i.beginPath(),i.arc(c,l,y.radius*w,0,Math.PI*2),i.strokeStyle=y.hue!==void 0?`hsla(${y.hue}, 100%, 70%, ${y.alpha})`:`rgba(255, 255, 255, ${y.alpha})`,i.lineWidth=2,i.stroke()}}function Tt(){for(let t=z.length-1;t>=0;t--){const e=z[t];if(e.x+=e.vx,e.y+=e.vy,e.vx*=.96,e.vy*=.96,e.life-=.02,e.life<=0){z.splice(t,1);continue}i.beginPath(),i.arc(e.x,e.y,2,0,Math.PI*2),i.fillStyle=e.hue?`hsla(${e.hue}, 100%, 70%, ${e.life})`:`rgba(255, 255, 255, ${e.life})`,i.fill()}}function vt(){if(P.length<180&&Math.random()<.45){let n,a,o,r;if(Math.random()<.2){switch(Math.floor(Math.random()*4)){case 0:n=Math.random()*h,a=-10;break;case 1:n=h+10,a=Math.random()*m;break;case 2:n=Math.random()*h,a=m+10;break;default:n=-10,a=Math.random()*m}const f=h/2,y=m/2,M=f-n,g=y-a,u=Math.sqrt(M*M+g*g);o=M/u*(.3+Math.random()*.3),r=g/u*(.3+Math.random()*.3)}else{const l=Math.random(),f=Math.random(),y=Math.sqrt(-2*Math.log(l))*Math.cos(2*Math.PI*f),M=Math.sqrt(-2*Math.log(l))*Math.sin(2*Math.PI*f);n=h/2+y*h*.35,a=m/2+M*m*.35,n=Math.max(20,Math.min(h-20,n)),a=Math.max(20,Math.min(m-20,a));const g=Math.random()*Math.PI*2,u=.05+Math.random()*.15;o=Math.cos(g)*u,r=Math.sin(g)*u}P.push({x:n,y:a,vx:o,vy:r,size:1.5+Math.random()*2.5,alpha:.4+Math.random()*.4,twinkle:Math.random()*Math.PI*2,absorbed:!1})}for(let n=P.length-1;n>=0;n--){const a=P[n],o=I-a.x,r=X-a.y,c=Math.sqrt(o*o+r*r),l=280;if(c<l&&c>8){const M=c/l,g=Math.pow(1-M,2)*.15;a.vx+=o/c*g,a.vy+=r/c*g,c<100&&(a.vx+=o/c*.08,a.vy+=r/c*.08)}if(c<20&&!a.absorbed&&b<G){a.absorbed=!0;const M=b;b=Math.min(G,b+.008),a.alpha*=.2,Math.floor(b*10)>Math.floor(M*10)&&(x.playCollect(Math.floor(b*5)),k.collect()),b>=G&&!s.active&&!E&&(H=Date.now()+1500,E=!0)}if(a.x+=a.vx,a.y+=a.vy,a.vx*=.985,a.vy*=.985,a.twinkle+=.05,a.absorbed&&(a.alpha*=.8),a.x<-50||a.x>h+50||a.y<-50||a.y>m+50||a.alpha<.01){P.splice(n,1);continue}const f=a.alpha*(.7+Math.sin(a.twinkle)*.3);let y=f;c<l&&!a.absorbed&&(y=f*(1+(1-c/l)*.5)),i.beginPath(),i.arc(a.x,a.y,a.size*(a.absorbed?.3:1),0,Math.PI*2),i.fillStyle=`rgba(255, 255, 255, ${Math.min(1,y)})`,i.fill()}}function At(){const t=Date.now()/1e3;if(E&&!s.active&&Date.now()>H){const g=Math.floor(Math.random()*4),u=3+Math.random()*2;switch(g){case 0:s.x=Math.random()*h,s.y=-10;break;case 1:s.x=h+10,s.y=Math.random()*m;break;case 2:s.x=Math.random()*h,s.y=m+10;break;default:s.x=-10,s.y=Math.random()*m}const d=h/2+(Math.random()-.5)*h*.4,T=m/2+(Math.random()-.5)*m*.4,A=d-s.x,v=T-s.y,q=Math.sqrt(A*A+v*v);s.vx=A/q*u,s.vy=v/q*u,s.active=!0,s.phase=Math.random()*Math.PI*2,s.turnTimer=0}if(!s.active)return;if(s.phase+=.08,s.turnTimer++,s.turnTimer>60+Math.random()*60){s.turnTimer=0;const g=(Math.random()-.5)*Math.PI*.8,u=Math.sqrt(s.vx*s.vx+s.vy*s.vy),T=Math.atan2(s.vy,s.vx)+g;s.vx=Math.cos(T)*u,s.vy=Math.sin(T)*u}const e=Math.sqrt(s.vx*s.vx+s.vy*s.vy),n=Math.sin(s.phase)*2.5+Math.sin(s.phase*2.3)*1.5,a=-s.vy/e,o=s.vx/e;s.x+=s.vx+a*n,s.y+=s.vy+o*n;const r=80,c=.15;s.x<r&&(s.vx+=c),s.x>h-r&&(s.vx-=c),s.y<r&&(s.vy+=c),s.y>m-r&&(s.vy-=c);const l=I-s.x,f=X-s.y;if(Math.sqrt(l*l+f*f)<30){if(s.active=!1,x.playCapture(),k.capture(),V&&S<L){if(S++,S>=L){x.playMaxStack(),k.maxStack();for(let g=0;g<100;g++){const u=g/100*Math.PI*2,d=12+Math.random()*12;z.push({x:s.x,y:s.y,vx:Math.cos(u)*d,vy:Math.sin(u)*d,life:1.5,hue:45})}}}else V=!0,C.style.filter="invert(1)",S=1;for(let g=0;g<60;g++){const u=g/60*Math.PI*2,d=8+Math.random()*8;z.push({x:s.x,y:s.y,vx:Math.cos(u)*d,vy:Math.sin(u)*d,life:1.2,hue:0})}for(let g=0;g<4;g++)setTimeout(()=>{R.push({x:s.x,y:s.y,size:10+g*30,alpha:1,hue:0})},g*50);V&&S<L&&b>=G&&(H=Date.now()+1500,E=!0)}(s.x<-100||s.x>h+100||s.y<-100||s.y>m+100)&&(s.active=!1,b>=G&&(H=Date.now()+2e3,E=!0));const M=1+Math.sin(t*10)*.2;i.beginPath(),i.arc(s.x,s.y,5*M,0,Math.PI*2),i.fillStyle="#ff2222",i.fill(),i.beginPath(),i.moveTo(s.x,s.y),i.lineTo(s.x-s.vx*2,s.y-s.vy*2),i.strokeStyle="rgba(255, 34, 34, 0.6)",i.lineWidth=3,i.stroke()}function St(){const t=i.createRadialGradient(h/2,m/2,Math.min(h,m)*.3,h/2,m/2,Math.max(h,m)*.8);t.addColorStop(0,"transparent"),t.addColorStop(.7,"transparent"),t.addColorStop(1,"rgba(0, 0, 0, 0.5)"),i.fillStyle=t,i.fillRect(0,0,h,m)}function wt(){for(let t=R.length-1;t>=0;t--){const e=R[t];if(e.size+=12,e.alpha-=.02,e.alpha<=0){R.splice(t,1);continue}i.beginPath(),i.arc(e.x,e.y,e.size,0,Math.PI*2),i.strokeStyle=e.hue!==void 0?`hsla(${e.hue}, 100%, 70%, ${e.alpha})`:`rgba(255, 255, 255, ${e.alpha})`,i.lineWidth=2,i.stroke()}}function Vt(){const t=h/2,e=m/2,n=Y-t,a=F-e,o=Math.sqrt(n*n+a*a);let r=0,c=0;const l=180;if(o<l&&b>=$){const v=1-o/l,q=b*v*.6;o>1&&(r=-(n/o)*q*o*.3,c=-(a/o)*q*o*.3)}const f=Y+r,y=F+c;I+=(f-I)*.25,X+=(y-X)*.25;const M=5,g=b*18,u=M+g;i.save(),i.translate(I,X);const d=5,T=G/d;for(let v=0;v<d;v++){const q=v*T,Z=Math.max(0,Math.min(1,(b-q)/T));if(Z<=0)continue;const pt=u+5+v*5,yt=4,gt=S>=d-v;i.beginPath(),i.arc(0,0,pt,-Math.PI/2,-Math.PI/2+Z*Math.PI*2),i.strokeStyle=gt?"#00ffff":"#ffffff",i.lineWidth=yt,i.lineCap="butt",i.stroke()}const A=S>=L;i.beginPath(),i.arc(0,0,u,0,Math.PI*2),i.fillStyle=A?"#00ffff":"#ffffff",i.fill(),i.restore()}function ht(){i.fillStyle="#000",i.fillRect(0,0,h,m),Mt(),vt(),At(),Tt(),bt(),wt(),Vt(),St(),requestAnimationFrame(ht)}window.addEventListener("resize",rt);document.addEventListener("mousemove",t=>{Y=t.clientX,F=t.clientY});document.addEventListener("click",t=>{const e=ct(t.clientX,t.clientY),n=Math.min(h,m)*.22*w,a=h/2,o=m/2;if(R.push({x:t.clientX,y:t.clientY,size:5,alpha:.5,hue:0}),e<n&&b>=$&&p<10){let r=1,c=!1;const l=p;S>=L?(c=!0,p=10,w=1+.18*10):V?(r=3*S,p=Math.min(10,p+r),w+=.18*r):(p=Math.min(10,p+1),w+=.18),x.playDischarge(p),k.discharge(),p>l&&setTimeout(()=>{x.playLevelUp(p),k.levelUp()},150),V&&(V=!1,C.style.filter=""),S=0,!x.bgMusicStarted&&b>=$&&x.startBgMusic();const f=b,y=c?45:p*40%360,M=c?30:5+p*2;for(let u=0;u<M;u++)setTimeout(()=>{D.push({alpha:1,radius:10+u*6,hue:c?(45+u*5)%60:(y+u*15)%360})},u*(c?10:20));O=c?1.5:1.2+p*.05,setTimeout(()=>{O=1},c?300:150),p>=10&&(U=!0,setTimeout(()=>{dt()},4e3));for(let u of P){const d=u.x-a,T=u.y-o,A=Math.sqrt(d*d+T*T);if(A>0&&A<400){const v=(1-A/400)*15*f;u.vx+=d/A*v,u.vy+=T/A*v}}const g=Math.floor(50+f*80+p*12);for(let u=0;u<g;u++){const d=u/g*Math.PI*2,T=6+Math.random()*12*f;z.push({x:a,y:o,vx:Math.cos(d)*T,vy:Math.sin(d)*T,life:1,hue:(y+Math.random()*60)%360})}for(let u=0;u<3;u++)setTimeout(()=>{R.push({x:a,y:o,size:10+u*20,alpha:1,hue:(y+u*30)%360})},u*40);b=0,E=!1,s.active=!1}});document.addEventListener("touchstart",t=>{const e=t.touches[0];Y=e.clientX,F=e.clientY});document.addEventListener("touchmove",t=>{const e=t.touches[0];Y=e.clientX,F=e.clientY,t.preventDefault()},{passive:!1});document.addEventListener("touchend",t=>{if(t.changedTouches.length>0){const e=t.changedTouches[0],n=ct(e.clientX,e.clientY),a=Math.min(h,m)*.22*w,o=h/2,r=m/2;if(R.push({x:e.clientX,y:e.clientY,size:5,alpha:.5,hue:0}),n<a&&b>=$&&p<10){let c=1,l=!1;const f=p;S>=L?(l=!0,p=10,w=1+.18*10):V?(c=3*S,p=Math.min(10,p+c),w+=.18*c):(p=Math.min(10,p+1),w+=.18),x.playDischarge(p),k.discharge(),p>f&&setTimeout(()=>{x.playLevelUp(p),k.levelUp()},150),V&&(V=!1,C.style.filter=""),S=0,!x.bgMusicStarted&&b>=$&&x.startBgMusic();const y=b,M=l?45:p*50%360,g=l?30:5+p*2;for(let d=0;d<g;d++)setTimeout(()=>{D.push({alpha:1,radius:15+d*8,hue:l?(45+d*5)%60:(M+d*20)%360})},d*(l?10:25));O=l?1.5:1.25,setTimeout(()=>{O=1},l?300:120),p>=10&&(U=!0,setTimeout(()=>{dt()},4e3));for(let d of P){const T=d.x-o,A=d.y-r,v=Math.sqrt(T*T+A*A);if(v>0&&v<400){const q=(1-v/400)*15*y;d.vx+=T/v*q,d.vy+=A/v*q}}const u=Math.floor(50+y*80+p*12);for(let d=0;d<u;d++){const T=d/u*Math.PI*2,A=6+Math.random()*12*y;z.push({x:o,y:r,vx:Math.cos(T)*A,vy:Math.sin(T)*A,life:1,hue:(M+Math.random()*60)%360})}for(let d=0;d<3;d++)setTimeout(()=>{R.push({x:o,y:r,size:10+d*20,alpha:1,hue:(M+d*30)%360})},d*40);b=0,E=!1,s.active=!1}}});const J=document.getElementById("sound-hint"),qt=J?.querySelectorAll("span:not(.speaker)");qt?.forEach((t,e)=>{const n=Math.random()*1.5;t.style.animationDelay=`${n}s`});function mt(){J?.classList.add("hidden")}const N=document.getElementById("sound-toggle"),it=N?.querySelector(".sound-on"),nt=N?.querySelector(".sound-off");function ft(t){it&&nt&&(it.style.display=t?"none":"block",nt.style.display=t?"block":"none"),N?.classList.toggle("muted",t)}function Et(){_(),x.muted&&x.toggleMute(),mt(),ft(!1)}J?.addEventListener("click",t=>{t.stopPropagation(),Et()});N?.addEventListener("click",t=>{t.stopPropagation(),_();const e=x.toggleMute();ft(e),e||mt(),e?x.stopBgMusic():x.bgMusic&&!x.bgMusicStarted&&x.startBgMusic()});rt();ht();
