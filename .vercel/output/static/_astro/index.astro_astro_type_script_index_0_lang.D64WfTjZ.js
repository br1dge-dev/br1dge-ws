const V=document.getElementById("canvas"),a=V.getContext("2d"),x={ctx:null,masterGain:null,compressor:null,initialized:!1,muted:!1,init(){if(!this.initialized)try{this.ctx=new(window.AudioContext||window.webkitAudioContext),this.compressor=this.ctx.createDynamicsCompressor(),this.compressor.threshold.setValueAtTime(-24,this.ctx.currentTime),this.compressor.knee.setValueAtTime(30,this.ctx.currentTime),this.compressor.ratio.setValueAtTime(12,this.ctx.currentTime),this.compressor.attack.setValueAtTime(.003,this.ctx.currentTime),this.compressor.release.setValueAtTime(.25,this.ctx.currentTime),this.compressor.connect(this.ctx.destination),this.masterGain=this.ctx.createGain(),this.masterGain.gain.setValueAtTime(.6,this.ctx.currentTime),this.masterGain.connect(this.compressor),this.initialized=!0}catch{console.warn("Web Audio API not supported")}},async resume(){this.ctx&&this.ctx.state==="suspended"&&await this.ctx.resume()},toggleMute(){if(!this.initialized)return!1;this.muted=!this.muted;const t=this.muted?0:.6;return this.masterGain.gain.linearRampToValueAtTime(t,this.ctx.currentTime+.1),this.muted},playCollect(t=0){if(!this.initialized||this.muted)return;const e=this.ctx.createOscillator(),s=this.ctx.createGain();e.connect(s),s.connect(this.masterGain);const i=[784,932,1047,1175,1397],o=i[Math.min(t,i.length-1)];e.type="sine",e.frequency.setValueAtTime(o,this.ctx.currentTime),e.frequency.linearRampToValueAtTime(o*1.05,this.ctx.currentTime+.04),s.gain.setValueAtTime(.08,this.ctx.currentTime),s.gain.exponentialRampToValueAtTime(.001,this.ctx.currentTime+.06),e.start(this.ctx.currentTime),e.stop(this.ctx.currentTime+.08)},playCapture(){if(!this.initialized||this.muted)return;const t=this.ctx.createOscillator(),e=this.ctx.createGain();t.connect(e),e.connect(this.masterGain),t.type="sine",t.frequency.setValueAtTime(98,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(49,this.ctx.currentTime+.15),e.gain.setValueAtTime(.4,this.ctx.currentTime),e.gain.exponentialRampToValueAtTime(.001,this.ctx.currentTime+.2),t.start(this.ctx.currentTime),t.stop(this.ctx.currentTime+.25),this.playNoiseBurst(.1,800)},playDischarge(t=1){if(!this.initialized||this.muted)return;const e=this.ctx.currentTime,s=this.ctx.createOscillator(),i=this.ctx.createGain();s.connect(i),i.connect(this.masterGain),s.type="sine",s.frequency.setValueAtTime(98+t*5,e),s.frequency.exponentialRampToValueAtTime(49,e+.2),i.gain.setValueAtTime(.35,e),i.gain.exponentialRampToValueAtTime(.001,e+.3),s.start(e),s.stop(e+.35),this.playNoiseBurst(.15,600+t*50)},playLevelUp(t=1){if(!this.initialized||this.muted)return;const e=this.ctx.currentTime;[392,466,587].forEach(i=>{const o=this.ctx.createOscillator(),r=this.ctx.createGain();o.connect(r),r.connect(this.masterGain),o.type="sine",o.frequency.setValueAtTime(i,e),r.gain.setValueAtTime(0,e),r.gain.linearRampToValueAtTime(.1,e+.15),r.gain.exponentialRampToValueAtTime(.001,e+.6),o.start(e),o.stop(e+.65)})},playMaxStack(){if(!this.initialized||this.muted)return;const t=this.ctx.currentTime;[196,233,294,349].forEach(s=>{const i=this.ctx.createOscillator(),o=this.ctx.createGain();i.connect(o),o.connect(this.masterGain),i.type="sine",i.frequency.setValueAtTime(s,t),o.gain.setValueAtTime(0,t),o.gain.linearRampToValueAtTime(.12,t+.2),o.gain.setValueAtTime(.12,t+.5),o.gain.exponentialRampToValueAtTime(.001,t+1.2),i.start(t),i.stop(t+1.3)})},playModalEnter(){if(!this.initialized||this.muted)return;const t=this.ctx.currentTime,e=this.ctx.createOscillator(),s=this.ctx.createGain();e.connect(s),s.connect(this.masterGain),e.type="sine",e.frequency.setValueAtTime(587,t),s.gain.setValueAtTime(0,t),s.gain.linearRampToValueAtTime(.12,t+.03),s.gain.exponentialRampToValueAtTime(.001,t+.8),e.start(t),e.stop(t+.85)},playModalClose(){if(!this.initialized||this.muted)return;const t=this.ctx.currentTime,e=this.ctx.createOscillator(),s=this.ctx.createGain();e.connect(s),s.connect(this.masterGain),e.type="sine",e.frequency.setValueAtTime(392,t),s.gain.setValueAtTime(.1,t),s.gain.exponentialRampToValueAtTime(.001,t+.35),e.start(t),e.stop(t+.4)},playNoiseBurst(t=.1,e=1e3){if(!this.initialized||this.muted)return;const s=this.ctx.currentTime,i=this.ctx.sampleRate*t,o=this.ctx.createBuffer(1,i,this.ctx.sampleRate),r=o.getChannelData(0);for(let f=0;f<i;f++)r[f]=Math.random()*2-1;const u=this.ctx.createBufferSource(),g=this.ctx.createBiquadFilter(),y=this.ctx.createGain();u.buffer=o,g.type="lowpass",g.frequency.setValueAtTime(e,s),u.connect(g),g.connect(y),y.connect(this.masterGain),y.gain.setValueAtTime(.15,s),y.gain.exponentialRampToValueAtTime(.001,s+t),u.start(s)},bgMusic:null,bgMusicGain:null,bgMusicStarted:!1,async loadBgMusic(){if(!(this.bgMusic||!this.initialized||!this.ctx))try{const e=await(await fetch("/bg-music.mp3")).arrayBuffer();this.bgMusic=await this.ctx.decodeAudioData(e)}catch(t){console.warn("Failed to load background music:",t)}},async startBgMusic(){if(!this.initialized||this.muted||this.bgMusicStarted||!this.bgMusic&&(await this.loadBgMusic(),!this.bgMusic))return;this.bgMusicStarted=!0;const t=this.ctx.createBufferSource();this.bgMusicGain=this.ctx.createGain(),t.buffer=this.bgMusic,t.loop=!0,t.connect(this.bgMusicGain),this.bgMusicGain.connect(this.masterGain),this.bgMusicGain.gain.setValueAtTime(0,this.ctx.currentTime),this.bgMusicGain.gain.linearRampToValueAtTime(.25,this.ctx.currentTime+2),t.start(0),this.bgMusicSource=t},stopBgMusic(){if(!this.bgMusicStarted||!this.bgMusicSource)return;const t=this.ctx.currentTime;this.bgMusicGain.gain.linearRampToValueAtTime(0,t+1),setTimeout(()=>{try{this.bgMusicSource.stop()}catch{}this.bgMusicStarted=!1},1100)}},z={supported:"vibrate"in navigator,vibrate(t){this.supported&&!x.muted&&navigator.vibrate(t)},collect(){this.vibrate(15)},capture(){this.vibrate(50)},discharge(){this.vibrate(100)},levelUp(){this.vibrate([25,50,25])},maxStack(){this.vibrate([40,80,40,80,40])},modalEnter(){this.vibrate(60)}};let tt=!1;function N(){tt||(tt=!0,x.init(),x.resume())}document.addEventListener("click",N,{once:!1});document.addEventListener("touchstart",N,{once:!1});document.addEventListener("visibilitychange",()=>{document.hidden&&x.bgMusicStarted&&x.bgMusicGain?x.bgMusicGain.gain.linearRampToValueAtTime(0,x.ctx.currentTime+.5):!document.hidden&&x.bgMusicStarted&&!x.muted&&x.bgMusicGain&&x.bgMusicGain.gain.linearRampToValueAtTime(.25,x.ctx.currentTime+.5)});let h,d,st,ot,Y=0,O=0,B=0,X=0,j=1,$=1,w=1,m=0,q=0;const D=[];let b=0;const F=.2,L=1;let P=!1,H=0,A=0;const I=6;let E=!1;const n={x:0,y:0,vx:0,vy:0,active:!1,phase:0,turnTimer:0};let _=!1;const G=[],R=[],C=[];function rt(){h=V.width=window.innerWidth,d=V.height=window.innerHeight,st=h/2,ot=d/2}function ct(t,e){const s=t-st,i=e-ot;return Math.sqrt(s*s+i*i)}let W=!1,K=0,J=0,et=0,it=0;function lt(t){x.playModalClose(),t.style.opacity="0",setTimeout(()=>{t.remove(),W=!1,_&&xt()},800)}function ut(t){m=0,w=1,b=0,P=!1,A=0,n.active=!1,E=!1,q=0,_=!1;const e=document.getElementById("restart-overlay-btn");e&&e.remove(),t&&lt(t)}function xt(){const t=document.getElementById("restart-overlay-btn");t&&t.remove();const e=document.createElement("button");e.id="restart-overlay-btn",e.textContent="RESTART";const s=Math.min(h,d)*.18*w;e.style.cssText=`
          position: fixed;
          left: 50%;
          top: calc(50% + ${s}px);
          transform: translateX(-50%);
          background: transparent;
          border: 1px solid rgba(255,255,255,0.2);
          color: rgba(255,255,255,0.4);
          padding: 0.5rem 1.2rem;
          font-size: 0.75rem;
          cursor: none;
          transition: all 0.3s;
          letter-spacing: 0.15em;
          font-family: "SF Pro Display", system-ui, sans-serif;
          z-index: 100;
          opacity: 0;
        `,e.addEventListener("mouseenter",()=>{e.style.borderColor="rgba(255,255,255,0.5)",e.style.color="#fff"}),e.addEventListener("mouseleave",()=>{e.style.borderColor="rgba(255,255,255,0.2)",e.style.color="rgba(255,255,255,0.4)"}),e.addEventListener("click",()=>ut(null)),document.body.appendChild(e),requestAnimationFrame(()=>{e.style.opacity="1"})}function ht(){if(W)return;W=!0,x.playModalEnter(),z.modalEnter(),V.style.filter="",E=!1;const t=document.createElement("div");t.id="level10-modal",t.style.cssText=`
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: #fff; color: #000; display: flex; flex-direction: column;
          justify-content: center; align-items: center; z-index: 1000;
          font-family: "SF Pro Display", "Helvetica Neue", system-ui, sans-serif;
          opacity: 0; transition: opacity 2.5s ease; cursor: none;
        `,t.innerHTML=`
          <button id="close-btn" style="position: absolute; top: 2rem; right: 2rem; background: transparent; border: none; color: #000; font-size: 1.5rem; cursor: none; padding: 0.5rem; opacity: 0.4; transition: opacity 0.3s;">✕</button>
          <div style="font-size: 7rem; font-weight: 100; margin-bottom: 0.5rem; letter-spacing: -0.05em;">∩</div>
          <h1 style="font-size: 2rem; font-weight: 200; margin-bottom: 1rem; letter-spacing: 0.3em; text-transform: uppercase;">Level 10</h1>
          <p style="font-size: 0.9rem; margin-bottom: 2.5rem; opacity: 0.5; font-weight: 300;">Good job! You may now follow me</p>
          <div style="display: flex; gap: 1.2rem; margin-bottom: 2rem;">
            <a href="https://x.com/br1dge_eth" target="_blank" class="modal-link" style="color: #000; text-decoration: none; font-size: 0.9rem; padding: 0.7rem 1.8rem; border: 1px solid rgba(0,0,0,0.2); transition: all 0.3s; letter-spacing: 0.1em;">X / TWITTER</a>
            <a href="https://farcaster.xyz/br1dge" target="_blank" class="modal-link" style="color: #000; text-decoration: none; font-size: 0.9rem; padding: 0.7rem 1.8rem; border: 1px solid rgba(0,0,0,0.2); transition: all 0.3s; letter-spacing: 0.1em;">FARCASTER</a>
          </div>
          <button id="restart-btn" style="background: transparent; border: 1px solid rgba(0,0,0,0.15); color: rgba(0,0,0,0.4); padding: 0.5rem 1.2rem; font-size: 0.75rem; cursor: none; transition: all 0.3s; letter-spacing: 0.15em; font-family: inherit;">RESTART</button>
          <p style="position: absolute; bottom: 2rem; font-size: 0.7rem; opacity: 0.25;">br1dge.xyz</p>
          <div id="modal-cursor" style="position: fixed; pointer-events: none; z-index: 1001;">
            <div style="width: 6px; height: 6px; background: #000; border-radius: 50%;"></div>
            <div style="position: absolute; top: -9px; left: -9px; width: 24px; height: 24px; border: 1px solid rgba(0,0,0,0.3); border-radius: 50%;"></div>
          </div>
        `,document.body.appendChild(t);const e=document.getElementById("modal-cursor"),s=document.getElementById("close-btn"),i=document.getElementById("restart-btn");t.addEventListener("mousemove",r=>{et=r.clientX,it=r.clientY});function o(){W&&(K+=(et-K)*.2,J+=(it-J)*.2,e&&(e.style.left=K-3+"px",e.style.top=J-3+"px"),requestAnimationFrame(o))}o(),s.addEventListener("mouseenter",()=>{s.style.opacity="1"}),s.addEventListener("mouseleave",()=>{s.style.opacity="0.4"}),s.addEventListener("click",()=>lt(t)),t.querySelectorAll(".modal-link").forEach(r=>{r.addEventListener("mouseenter",()=>{r.style.background="rgba(0,0,0,0.05)",r.style.borderColor="#000"}),r.addEventListener("mouseleave",()=>{r.style.background="transparent",r.style.borderColor="rgba(0,0,0,0.2)"})}),i.addEventListener("mouseenter",()=>{i.style.borderColor="rgba(0,0,0,0.4)",i.style.color="#000"}),i.addEventListener("mouseleave",()=>{i.style.borderColor="rgba(0,0,0,0.15)",i.style.color="rgba(0,0,0,0.4)"}),i.addEventListener("click",()=>ut(t)),requestAnimationFrame(()=>{t.style.opacity="1"})}function Mt(){a.fillStyle="#000000",a.fillRect(0,0,h,d);const t=a.createRadialGradient(h/2,d/2,0,h/2,d/2,Math.max(h,d)*.7);t.addColorStop(0,"rgba(20, 20, 25, 0.5)"),t.addColorStop(1,"transparent"),a.fillStyle=t,a.fillRect(0,0,h,d);const e=80,s=1;a.fillStyle="rgba(255, 255, 255, 0.03)";for(let i=e;i<h;i+=e)for(let o=e;o<d;o+=e)a.beginPath(),a.arc(i,o,s,0,Math.PI*2),a.fill();a.strokeStyle="rgba(255, 255, 255, 0.015)",a.lineWidth=1;for(let i=0;i<h;i+=200)a.beginPath(),a.moveTo(i,0),a.lineTo(i,d),a.stroke()}function bt(){const t=Math.min(h,d)*.32;j+=($-j)*.12,q+=.008;const e=Math.sin(q)*.008,s=Math.sin(q*1.7)*.003,i=Math.sin(q*.5)*.005,o=1+e+s+i,r=w*j*o,u=h/2,g=d/2;if(a.save(),a.translate(u,g),a.scale(r,r),a.font=`200 ${t}px "SF Pro Display", "Helvetica Neue", system-ui, sans-serif`,a.textAlign="center",a.textBaseline="middle",m>0){let y;m<=4?y=2+m*1:y=6+Math.log(m-3)*1.5;const f=y;let M;m<=4?M=.15+m*.04:M=.31+Math.log(m-3)*.025,a.globalAlpha=M,a.fillStyle="#ff0066",a.fillText("∩",-f,0),a.fillStyle="#00ffff",a.fillText("∩",f,0),a.globalAlpha=1}a.fillStyle="#ffffff",a.fillText("∩",0,0),a.restore(),a.font="12px monospace",a.textAlign="right",a.fillStyle="rgba(255, 255, 255, 0.4)",a.fillText(`lvl:${m}`,h-20,d-20);for(let y=D.length-1;y>=0;y--){const f=D[y];if(f.alpha*=.96,f.radius=(f.radius||10)+5,f.alpha<.01){D.splice(y,1);continue}a.beginPath(),a.arc(u,g,f.radius*w,0,Math.PI*2),a.strokeStyle=f.hue!==void 0?`hsla(${f.hue}, 100%, 70%, ${f.alpha})`:`rgba(255, 255, 255, ${f.alpha})`,a.lineWidth=2,a.stroke()}}function vt(){for(let t=G.length-1;t>=0;t--){const e=G[t];if(e.x+=e.vx,e.y+=e.vy,e.vx*=.96,e.vy*=.96,e.life-=.02,e.life<=0){G.splice(t,1);continue}a.beginPath(),a.arc(e.x,e.y,2,0,Math.PI*2),a.fillStyle=e.hue?`hsla(${e.hue}, 100%, 70%, ${e.life})`:`rgba(255, 255, 255, ${e.life})`,a.fill()}}function Tt(){if(C.length<180&&Math.random()<.45){let s,i,o,r;if(Math.random()<.2){switch(Math.floor(Math.random()*4)){case 0:s=Math.random()*h,i=-10;break;case 1:s=h+10,i=Math.random()*d;break;case 2:s=Math.random()*h,i=d+10;break;default:s=-10,i=Math.random()*d}const y=h/2,f=d/2,M=y-s,p=f-i,c=Math.sqrt(M*M+p*p);o=M/c*(.3+Math.random()*.3),r=p/c*(.3+Math.random()*.3)}else{const g=Math.random(),y=Math.random(),f=Math.sqrt(-2*Math.log(g))*Math.cos(2*Math.PI*y),M=Math.sqrt(-2*Math.log(g))*Math.sin(2*Math.PI*y);s=h/2+f*h*.35,i=d/2+M*d*.35,s=Math.max(20,Math.min(h-20,s)),i=Math.max(20,Math.min(d-20,i));const p=Math.random()*Math.PI*2,c=.05+Math.random()*.15;o=Math.cos(p)*c,r=Math.sin(p)*c}C.push({x:s,y:i,vx:o,vy:r,size:1.5+Math.random()*2.5,alpha:.4+Math.random()*.4,twinkle:Math.random()*Math.PI*2,absorbed:!1})}for(let s=C.length-1;s>=0;s--){const i=C[s],o=B-i.x,r=X-i.y,u=Math.sqrt(o*o+r*r),g=280;if(u<g&&u>8){const M=u/g,p=Math.pow(1-M,2)*.15;i.vx+=o/u*p,i.vy+=r/u*p,u<100&&(i.vx+=o/u*.08,i.vy+=r/u*.08)}if(u<20&&!i.absorbed&&b<L){i.absorbed=!0;const M=b;b=Math.min(L,b+.008),i.alpha*=.2,Math.floor(b*10)>Math.floor(M*10)&&(x.playCollect(Math.floor(b*5)),z.collect()),b>=L&&!n.active&&!P&&(H=Date.now()+1500,P=!0)}if(i.x+=i.vx,i.y+=i.vy,i.vx*=.985,i.vy*=.985,i.twinkle+=.05,i.absorbed&&(i.alpha*=.8),i.x<-50||i.x>h+50||i.y<-50||i.y>d+50||i.alpha<.01){C.splice(s,1);continue}const y=i.alpha*(.7+Math.sin(i.twinkle)*.3);let f=y;u<g&&!i.absorbed&&(f=y*(1+(1-u/g)*.5)),a.beginPath(),a.arc(i.x,i.y,i.size*(i.absorbed?.3:1),0,Math.PI*2),a.fillStyle=`rgba(255, 255, 255, ${Math.min(1,f)})`,a.fill()}}function St(){const t=Date.now()/1e3;if(P&&!n.active&&Date.now()>H){const p=Math.floor(Math.random()*4),c=3+Math.random()*2;switch(p){case 0:n.x=Math.random()*h,n.y=-10;break;case 1:n.x=h+10,n.y=Math.random()*d;break;case 2:n.x=Math.random()*h,n.y=d+10;break;default:n.x=-10,n.y=Math.random()*d}const l=h/2+(Math.random()-.5)*h*.4,v=d/2+(Math.random()-.5)*d*.4,S=l-n.x,T=v-n.y,k=Math.sqrt(S*S+T*T);n.vx=S/k*c,n.vy=T/k*c,n.active=!0,n.phase=Math.random()*Math.PI*2,n.turnTimer=0}if(!n.active)return;if(n.phase+=.08,n.turnTimer++,n.turnTimer>60+Math.random()*60){n.turnTimer=0;const p=(Math.random()-.5)*Math.PI*.8,c=Math.sqrt(n.vx*n.vx+n.vy*n.vy),v=Math.atan2(n.vy,n.vx)+p;n.vx=Math.cos(v)*c,n.vy=Math.sin(v)*c}const e=Math.sqrt(n.vx*n.vx+n.vy*n.vy),s=Math.sin(n.phase)*2.5+Math.sin(n.phase*2.3)*1.5,i=-n.vy/e,o=n.vx/e;n.x+=n.vx+i*s,n.y+=n.vy+o*s;const r=80,u=.15;n.x<r&&(n.vx+=u),n.x>h-r&&(n.vx-=u),n.y<r&&(n.vy+=u),n.y>d-r&&(n.vy-=u);const g=B-n.x,y=X-n.y;if(Math.sqrt(g*g+y*y)<30){if(n.active=!1,x.playCapture(),z.capture(),E&&A<I){if(A++,A>=I){x.playMaxStack(),z.maxStack();for(let p=0;p<100;p++){const c=p/100*Math.PI*2,l=12+Math.random()*12;G.push({x:n.x,y:n.y,vx:Math.cos(c)*l,vy:Math.sin(c)*l,life:1.5,hue:45})}}}else E=!0,V.style.filter="invert(1)",A=1;for(let p=0;p<60;p++){const c=p/60*Math.PI*2,l=8+Math.random()*8;G.push({x:n.x,y:n.y,vx:Math.cos(c)*l,vy:Math.sin(c)*l,life:1.2,hue:0})}for(let p=0;p<4;p++)setTimeout(()=>{R.push({x:n.x,y:n.y,size:10+p*30,alpha:1,hue:0})},p*50);E&&A<I&&b>=L&&(H=Date.now()+1500,P=!0)}(n.x<-100||n.x>h+100||n.y<-100||n.y>d+100)&&(n.active=!1,b>=L&&(H=Date.now()+2e3,P=!0));const M=1+Math.sin(t*10)*.2;a.beginPath(),a.arc(n.x,n.y,5*M,0,Math.PI*2),a.fillStyle="#ff2222",a.fill(),a.beginPath(),a.moveTo(n.x,n.y),a.lineTo(n.x-n.vx*2,n.y-n.vy*2),a.strokeStyle="rgba(255, 34, 34, 0.6)",a.lineWidth=3,a.stroke()}function At(){const t=a.createRadialGradient(h/2,d/2,Math.min(h,d)*.3,h/2,d/2,Math.max(h,d)*.8);t.addColorStop(0,"transparent"),t.addColorStop(.7,"transparent"),t.addColorStop(1,"rgba(0, 0, 0, 0.5)"),a.fillStyle=t,a.fillRect(0,0,h,d)}function wt(){for(let t=R.length-1;t>=0;t--){const e=R[t];if(e.size+=12,e.alpha-=.02,e.alpha<=0){R.splice(t,1);continue}a.beginPath(),a.arc(e.x,e.y,e.size,0,Math.PI*2),a.strokeStyle=e.hue!==void 0?`hsla(${e.hue}, 100%, 70%, ${e.alpha})`:`rgba(255, 255, 255, ${e.alpha})`,a.lineWidth=2,a.stroke()}}function Et(){const t=h/2,e=d/2,s=Y-t,i=O-e,o=Math.sqrt(s*s+i*i);let r=0,u=0;const g=180;if(o<g&&b>=F){const T=1-o/g,k=b*T*.6;o>1&&(r=-(s/o)*k*o*.3,u=-(i/o)*k*o*.3)}const y=Y+r,f=O+u;B+=(y-B)*.25,X+=(f-X)*.25;const M=5,p=b*18,c=M+p;a.save(),a.translate(B,X);const l=5,v=L/l;for(let T=0;T<l;T++){const k=T*v,Z=Math.max(0,Math.min(1,(b-k)/v));if(Z<=0)continue;const pt=c+5+T*5,gt=4,yt=A>=l-T;a.beginPath(),a.arc(0,0,pt,-Math.PI/2,-Math.PI/2+Z*Math.PI*2),a.strokeStyle=yt?"#00ffff":"#ffffff",a.lineWidth=gt,a.lineCap="butt",a.stroke()}const S=A>=I;a.beginPath(),a.arc(0,0,c,0,Math.PI*2),a.fillStyle=S?"#00ffff":"#ffffff",a.fill(),a.restore()}function dt(){a.fillStyle="#000",a.fillRect(0,0,h,d),Mt(),Tt(),St(),vt(),bt(),wt(),Et(),At(),requestAnimationFrame(dt)}window.addEventListener("resize",rt);document.addEventListener("mousemove",t=>{Y=t.clientX,O=t.clientY});document.addEventListener("click",t=>{const e=ct(t.clientX,t.clientY),s=Math.min(h,d)*.22*w,i=h/2,o=d/2;if(R.push({x:t.clientX,y:t.clientY,size:5,alpha:.5,hue:0}),e<s&&b>=F&&m<10){let r=1,u=!1;const g=m;A>=I?(u=!0,m=10,w=1+.18*10):E?(r=3*A,m=Math.min(10,m+r),w+=.18*r):(m=Math.min(10,m+1),w+=.18),x.playDischarge(m),z.discharge(),m>g&&setTimeout(()=>{x.playLevelUp(m),z.levelUp()},150),E&&(E=!1,V.style.filter=""),A=0,!x.bgMusicStarted&&b>=F&&x.startBgMusic();const y=b,f=u?45:m*40%360,M=u?30:5+m*2;for(let c=0;c<M;c++)setTimeout(()=>{D.push({alpha:1,radius:10+c*6,hue:u?(45+c*5)%60:(f+c*15)%360})},c*(u?10:20));$=u?1.5:1.2+m*.05,setTimeout(()=>{$=1},u?300:150),m>=10&&(_=!0,setTimeout(()=>{ht()},4e3));for(let c of C){const l=c.x-i,v=c.y-o,S=Math.sqrt(l*l+v*v);if(S>0&&S<400){const T=(1-S/400)*15*y;c.vx+=l/S*T,c.vy+=v/S*T}}const p=Math.floor(50+y*80+m*12);for(let c=0;c<p;c++){const l=c/p*Math.PI*2,v=6+Math.random()*12*y;G.push({x:i,y:o,vx:Math.cos(l)*v,vy:Math.sin(l)*v,life:1,hue:(f+Math.random()*60)%360})}for(let c=0;c<3;c++)setTimeout(()=>{R.push({x:i,y:o,size:10+c*20,alpha:1,hue:(f+c*30)%360})},c*40);b=0,P=!1,n.active=!1}});document.addEventListener("touchstart",t=>{const e=t.touches[0];Y=e.clientX,O=e.clientY});document.addEventListener("touchmove",t=>{const e=t.touches[0];Y=e.clientX,O=e.clientY,t.preventDefault()},{passive:!1});document.addEventListener("touchend",t=>{if(t.changedTouches.length>0){const e=t.changedTouches[0],s=ct(e.clientX,e.clientY),i=Math.min(h,d)*.22*w,o=h/2,r=d/2;if(R.push({x:e.clientX,y:e.clientY,size:5,alpha:.5,hue:0}),s<i&&b>=F&&m<10){let u=1,g=!1;const y=m;A>=I?(g=!0,m=10,w=1+.18*10):E?(u=3*A,m=Math.min(10,m+u),w+=.18*u):(m=Math.min(10,m+1),w+=.18),x.playDischarge(m),z.discharge(),m>y&&setTimeout(()=>{x.playLevelUp(m),z.levelUp()},150),E&&(E=!1,V.style.filter=""),A=0,!x.bgMusicStarted&&b>=F&&x.startBgMusic();const f=b,M=g?45:m*50%360,p=g?30:5+m*2;for(let l=0;l<p;l++)setTimeout(()=>{D.push({alpha:1,radius:15+l*8,hue:g?(45+l*5)%60:(M+l*20)%360})},l*(g?10:25));$=g?1.5:1.25,setTimeout(()=>{$=1},g?300:120),m>=10&&(_=!0,setTimeout(()=>{ht()},4e3));for(let l of C){const v=l.x-o,S=l.y-r,T=Math.sqrt(v*v+S*S);if(T>0&&T<400){const k=(1-T/400)*15*f;l.vx+=v/T*k,l.vy+=S/T*k}}const c=Math.floor(50+f*80+m*12);for(let l=0;l<c;l++){const v=l/c*Math.PI*2,S=6+Math.random()*12*f;G.push({x:o,y:r,vx:Math.cos(v)*S,vy:Math.sin(v)*S,life:1,hue:(M+Math.random()*60)%360})}for(let l=0;l<3;l++)setTimeout(()=>{R.push({x:o,y:r,size:10+l*20,alpha:1,hue:(M+l*30)%360})},l*40);b=0,P=!1,n.active=!1}}});const Q=document.getElementById("sound-hint"),kt=Q?.querySelectorAll("span:not(.speaker)");kt?.forEach((t,e)=>{const s=Math.random()*1.5;t.style.animationDelay=`${s}s`});function mt(){Q?.classList.add("hidden")}const U=document.getElementById("sound-toggle"),at=U?.querySelector(".sound-on"),nt=U?.querySelector(".sound-off");function ft(t){at&&nt&&(at.style.display=t?"none":"block",nt.style.display=t?"block":"none"),U?.classList.toggle("muted",t)}function Pt(){N(),x.muted&&x.toggleMute(),mt(),ft(!1)}Q?.addEventListener("click",t=>{t.stopPropagation(),Pt()});U?.addEventListener("click",t=>{t.stopPropagation(),N();const e=x.toggleMute();ft(e),e||mt(),e?x.stopBgMusic():x.bgMusic&&!x.bgMusicStarted&&x.startBgMusic()});rt();dt();
